<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Meu Controle de Gastos</title>
  
  <!-- Comportamento como app -->
  <meta name="theme-color" content="#4CAF50" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Controle" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- √çcone -->
  <link rel="apple-touch-icon" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%234CAF50'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white'>üí∞</text></svg>">
  <link rel="icon" type="image/png" sizes="192x192" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%234CAF50'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white'>üí∞</text></svg>">

  <style>
    :root {
      --primary: #4CAF50;
      --light: #E8F5E9;
      --dark: #2E7D32;
      --gray: #9E9E9E;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      background-color: var(--light);
      color: #333;
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
      touch-action: manipulation;
    }

    /* Modal de boas-vindas */
    #welcomeModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      padding: 24px;
      z-index: 2000;
      overflow-y: auto;
    }
    #welcomeModal h2 {
      color: var(--dark);
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.4rem;
    }
    #welcomeModal p {
      margin: 12px 0;
      line-height: 1.6;
      font-size: 1rem;
    }
    #welcomeModal button {
      display: block;
      margin: 24px auto 0;
      padding: 14px 32px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      cursor: pointer;
      min-height: 48px;
    }
    #welcomeModal button:hover {
      background: var(--dark);
    }

    /* Tela de bloqueio */
    #lockScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    #lockScreen h2 {
      margin-bottom: 20px;
      color: var(--dark);
      font-size: 1.4rem;
    }
    #pinInput {
      width: 180px;
      padding: 14px;
      font-size: 1.6rem;
      text-align: center;
      border: 2px solid var(--primary);
      border-radius: 12px;
      margin-bottom: 16px;
      font-family: inherit;
    }
    #lockScreen button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      margin: 8px;
      min-height: 48px;
      font-size: 1.1rem;
    }
    #lockScreen button:hover {
      background: var(--dark);
    }
    #mainApp { display: none; }

    /* Meta de hoje ‚Äî discreta */
    .meta-box {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: relative;
    }
    .meta-box::before {
      content: "üéØ";
      position: absolute;
      top: 12px;
      left: 16px;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .meta-title {
      font-weight: bold;
      color: var(--dark);
      margin-bottom: 8px;
      padding-left: 32px;
    }
    .meta-value {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      padding-left: 32px;
    }
    .meta-progress {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
    }
    .meta-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
      width: 0%;
      transition: width 0.4s ease;
    }
    .meta-info {
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
      margin: 8px 0;
      padding-left: 32px;
    }

    /* Balan√ßo principal */
    .balance {
      background: white;
      padding: 14px;
      border-radius: 16px;
      margin: 16px 0;
      text-align: center;
      font-weight: bold;
      color: var(--dark);
      font-size: 1.1rem;
    }

    /* Restante do app ‚Äî mantido limpo */
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 14px 0;
      color: white;
      background: var(--primary);
      border-radius: 16px;
    }
    h1 { font-size: 1.5rem; }
    .form-group { margin: 14px 0; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 1rem;
      min-height: 48px;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    button.app-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 12px;
      cursor: pointer;
      min-height: 48px;
    }
    button.app-btn:hover {
      background: var(--dark);
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin: 16px 0;
    }
    .cal-day {
      text-align: center;
      padding: 8px 4px;
      font-size: 0.9rem;
      background: #e0e0e0;
      border-radius: 8px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cal-day.has-data {
      background: var(--primary);
      color: white;
    }
    .cal-day.today {
      border: 2px solid var(--dark);
    }

    .summary-table, .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .summary-table th,
    .summary-table td,
    .report-table th,
    .report-table td {
      padding: 14px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
    }
    .summary-table th,
    .report-table th {
      background: var(--primary);
      color: white;
      font-weight: bold;
    }
    .summary-table tr:last-child td,
    .report-table tr:last-child td {
      border-bottom: none;
    }
    .summary-table tr:hover td,
    .report-table tr:hover td {
      background-color: #f9f9f9;
    }

    .monthly-summary {
      background: white;
      padding: 16px;
      border-radius: 16px;
      margin: 24px 0;
      text-align: center;
    }
    .month-nav {
      display: flex;
      justify-content: space-between;
      max-width: 220px;
      margin: 12px auto;
    }
    .month-nav button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 1.2rem;
      min-width: 44px;
      min-height: 44px;
    }

    footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #ccc;
      text-align: center;
      font-size: 0.85rem;
      color: #666;
      line-height: 1.5;
    }
    footer a {
      color: var(--primary);
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Modal de boas-vindas -->
  <div id="welcomeModal" style="display:none;">
    <h2>üåø Bem-vindo(a) ao seu Controle de Gastos</h2>
    
    <p>Este aplicativo foi criado por <strong>Ricardo de Faria Barros</strong> no contexto do <strong>Projeto 70+ da ANABB</strong>, com o prop√≥sito de apoiar a autonomia financeira e o bem-estar na longevidade.</p>

    <p>Sabemos que, na longevidade, pequenos gastos eventuais ‚Äî como delivery, compras online por impulso ou assinaturas esquecidas ‚Äî podem, aos poucos, "sangrar" suas economias. N√£o se trata de viver com mis√©ria, mas de fazer escolhas conscientes.</p>

    <p>üîí <strong>Seus dados ficam apenas no seu celular</strong> ‚Äî nada √© enviado para a nuvem.</p>

    <p>üì± Para usar como app nativo:  
    ‚Ä¢ Android: Chrome ‚Üí tr√™s pontinhos ‚Üí ‚ÄúAdicionar √† tela inicial‚Äù  
    ‚Ä¢ iPhone: Compartilhar ‚Üí ‚ÄúAdicionar √† Tela de In√≠cio‚Äù</p>

    <button onclick="closeWelcome()">Come√ßar</button>
  </div>

  <!-- Tela de bloqueio -->
  <div id="lockScreen">
    <h2>üîí Prote√ß√£o por PIN</h2>
    <input type="password" id="pinInput" maxlength="4" placeholder="____" autocomplete="off">
    <button onclick="unlockApp()">Acessar</button>
    <button onclick="resetPin()" style="background:#f44336;">Esqueci o PIN</button>
    <p id="pinMessage" style="margin-top:12px;color:#666;"></p>
  </div>

  <!-- App principal -->
  <div id="mainApp">
    <header>
      <h1>üí∞ Meu Controle Di√°rio</h1>
    </header>

    <!-- Meta de hoje (discreta) -->
    <div class="meta-box" id="metaBox">
      <div class="meta-title">META DE HOJE</div>
      <div class="meta-value" id="metaValue">R$ 0,00</div>
      <div class="meta-info" id="metaInfo">Defina sua meta para acompanhar seu or√ßamento di√°rio</div>
      <div class="meta-progress">
        <div class="meta-fill" id="metaFill"></div>
      </div>
      <button onclick="defineMeta()" style="margin-top:12px;background:#f1f8e9;color:#2E7D32;border:1px solid #4CAF50;padding:8px 16px;font-size:0.9rem;">
        üéØ Definir meta
      </button>
    </div>

    <div class="balance" id="balance">Balan√ßo de hoje: R$ 0,00</div>

    <div class="form-group">
      <label for="date">Data do gasto</label>
      <input type="date" id="date">
    </div>

    <div class="form-group">
      <label for="category">Categoria</label>
      <select id="category">
        <option value="alimentacao">üõí Alimenta√ß√£o</option>
        <option value="feira">üß∫ Feira</option>
        <option value="padaria">ü•ê Padaria</option>
        <option value="bares">üç∑ Bares/Restaurantes</option>
        <option value="farmacia">üíä Farm√°cia</option>
        <option value="gasolina">‚õΩ Gasolina</option>
        <option value="uber">üöï Uber/Transporte</option>
        <option value="agua">üíß √Ågua</option>
        <option value="energia">‚ö° Energia</option>
        <option value="telefone">üì± Telefone/Internet</option>
        <option value="condominio">üè¢ Condom√≠nio</option>
        <option value="diarista">üßπ Diarista</option>
        <option value="impostos">üèõÔ∏è Impostos</option>
        <option value="prestacoes">üè† Presta√ß√µes (casa/carro)</option>
        <option value="manutencao">üîß Manuten√ß√£o (casa/carro)</option>
        <option value="lazer">üé≠ Lazer</option>
        <option value="contas">üìÑ Contas Fixas</option>
        <option value="aluguel">üè† Aluguel</option>
        <option value="cartao">üí≥ Fatura Cart√£o</option>
        <option value="dizimo">‚ù§Ô∏è D√≠zimo/Doa√ß√£o</option>
        <option value="online">üì¶ Compras Online</option>
        <option value="mensalidade">üèãÔ∏è‚Äç‚ôÇÔ∏è Mensalidade (academia/clube)</option>
        <option value="educacao">üéì Educa√ß√£o</option>
        <option value="ajuda_familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ajuda a filhos/netos</option>
        <option value="saque">üèß Saques (Dinheiro Vivo)</option>
        <option value="economia">üí∞ Economia / Poupan√ßa</option>
        <option value="diversos">‚ú® Diversos</option>
      </select>
    </div>

    <div class="form-group">
      <label for="amount">Valor (R$)</label>
      <input type="number" id="amount" step="0.01" placeholder="0,00" min="0">
    </div>

    <div class="form-group">
      <label for="note">Observa√ß√£o (opcional)</label>
      <textarea id="note" placeholder="Ex: Economizei R$ 50 para emerg√™ncias"></textarea>
    </div>

    <button class="app-btn" onclick="addExpense()">‚ûï Registrar Gasto</button>

    <div class="monthly-summary">
      <div class="month-nav">
        <button onclick="changeMonth(-1)">‚óÄ</button>
        <span id="currentMonth">Fevereiro 2026</span>
        <button onclick="changeMonth(1)">‚ñ∂</button>
      </div>
      <div id="monthlyStats">Total: R$ 0,00 | Dias: 0/29 | M√©dia: R$ 0,00</div>
    </div>

    <div class="calendar" id="calendar"></div>

    <h3 style="margin-top: 24px; font-size: 1.2rem;">üìÖ Resumo Di√°rio</h3>
    <table class="summary-table" id="summaryTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="summaryBody">
      </tbody>
    </table>

    <h3 style="margin-top: 24px; font-size: 1.2rem;">üìä Total por Categoria</h3>
    <table class="report-table" id="categoryReport">
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="categoryReportBody">
      </tbody>
    </table>

    <button class="app-btn" style="background:#2196F3;margin-top:20px;" onclick="generatePDF()">üìÑ Gerar Relat√≥rio PDF</button>

    <button class="app-btn" style="background:#E8F5E9;color:#2E7D32;border:1px solid #4CAF50;margin-top:16px;font-weight:bold;"
            onclick="window.open('https://www.plenalongevidade.com.br', '_blank')">
      üåø Conhe√ßa a Plena Longevidade
    </button>

    <footer>
      ¬© 2026 Ricardo de Faria Barros. Todos os direitos reservados.<br>
      <strong>D√∫vidas ou sugest√µes?</strong> Escreva para: <a href="mailto:ricardo@animodh.com.br">ricardo@animodh.com.br</a>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Meta de hoje ---
    let metaDiaria = parseFloat(localStorage.getItem('dailyMeta')) || 0;

    function updateMetaDisplay() {
      const totalHoje = getTodayTotal();
      const percent = metaDiaria > 0 ? Math.min(100, (totalHoje / metaDiaria) * 100) : 0;
      document.getElementById('metaValue').textContent = formatCurrency(metaDiaria);
      document.getElementById('metaFill').style.width = `${percent}%`;
      document.getElementById('metaInfo').textContent = 
        metaDiaria > 0 
          ? `Gastou ${formatCurrency(totalHoje)} de ${formatCurrency(metaDiaria)}`
          : "Defina sua meta para acompanhar seu or√ßamento di√°rio";
    }

    function defineMeta() {
      const newMeta = parseFloat(prompt("Digite sua meta di√°ria (ex: 80)", metaDiaria || "80"));
      if (newMeta !== null && !isNaN(newMeta) && newMeta >= 0) {
        metaDiaria = newMeta;
        localStorage.setItem('dailyMeta', metaDiaria.toString());
        updateMetaDisplay();
      }
    }

    // --- Primeira vez ---
    if (!localStorage.getItem('appVisited')) {
      document.getElementById('welcomeModal').style.display = 'block';
      document.getElementById('lockScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
    }

    function closeWelcome() {
      localStorage.setItem('appVisited', 'true');
      document.getElementById('welcomeModal').style.display = 'none';
      document.getElementById('lockScreen').style.display = 'flex';
    }

    // --- PIN ---
    function hashPin(pin) {
      let hash = 0;
      for (let i = 0; i < pin.length; i++) {
        const char = pin.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString();
    }

    function setPin(pin) {
      localStorage.setItem('appPinHash', hashPin(pin));
    }

    function verifyPin(pin) {
      const savedHash = localStorage.getItem('appPinHash');
      return savedHash && savedHash === hashPin(pin);
    }

    function hasPin() {
      return localStorage.getItem('appPinHash') !== null;
    }

    function unlockApp() {
      const pin = document.getElementById('pinInput').value;
      const msg = document.getElementById('pinMessage');

      if (pin.length !== 4 || isNaN(pin)) {
        msg.textContent = "O PIN deve ter 4 d√≠gitos.";
        msg.style.color = "#f44336";
        return;
      }

      if (!hasPin()) {
        setPin(pin);
        msg.textContent = "PIN definido com sucesso!";
        msg.style.color = "#4CAF50";
        setTimeout(() => {
          document.getElementById('lockScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          updateMetaDisplay();
          render();
        }, 1000);
      } else {
        if (verifyPin(pin)) {
          document.getElementById('lockScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          updateMetaDisplay();
          render();
        } else {
          msg.textContent = "PIN incorreto. Tente novamente.";
          msg.style.color = "#f44336";
          document.getElementById('pinInput').value = '';
        }
      }
    }

    function resetPin() {
      if (confirm("Isso apagar√° todos os seus dados de gastos. Deseja continuar?")) {
        localStorage.removeItem('appPinHash');
        localStorage.removeItem('expenses');
        localStorage.removeItem('dailyMeta');
        document.getElementById('pinInput').value = '';
        document.getElementById('pinMessage').textContent = "Dados apagados. Defina um novo PIN.";
        document.getElementById('pinMessage').style.color = "#4CAF50";
        metaDiaria = 0;
        updateMetaDisplay();
      }
    }

    // --- Dados ---
    function formatDate(date = new Date()) {
      return date.toISOString().split('T')[0];
    }

    function formatBR(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    function getDatesLast7Days() {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(formatDate(d));
      }
      return dates;
    }

    function getMonthDates(year, month) {
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      const days = [];
      for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
        days.push(formatDate(new Date(d)));
      }
      return days;
    }

    const categoryNames = {
      "alimentacao": "Alimenta√ß√£o",
      "feira": "Feira",
      "padaria": "Padaria",
      "bares": "Bares/Restaurantes",
      "farmacia": "Farm√°cia",
      "gasolina": "Gasolina",
      "uber": "Uber/Transporte",
      "agua": "√Ågua",
      "energia": "Energia",
      "telefone": "Telefone/Internet",
      "condominio": "Condom√≠nio",
      "diarista": "Diarista",
      "impostos": "Impostos",
      "prestacoes": "Presta√ß√µes",
      "manutencao": "Manuten√ß√£o",
      "lazer": "Lazer",
      "contas": "Contas Fixas",
      "aluguel": "Aluguel",
      "cartao": "Fatura Cart√£o",
      "dizimo": "D√≠zimo/Doa√ß√£o",
      "online": "Compras Online",
      "mensalidade": "Mensalidade (academia/clube)",
      "educacao": "Educa√ß√£o",
      "ajuda_familia": "Ajuda a filhos/netos",
      "saque": "Saques (Dinheiro Vivo)",
      "economia": "Economia / Poupan√ßa",
      "diversos": "Diversos"
    };

    let expenses = JSON.parse(localStorage.getItem('expenses')) || {};
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    const today = formatDate();

    document.getElementById('date').value = today;

    function save() {
      localStorage.setItem('expenses', JSON.stringify(expenses));
      render();
    }

    function addExpense() {
      const dateInput = document.getElementById('date').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const note = (document.getElementById('note').value || '').trim();

      if (!dateInput) {
        alert('Selecione uma data.');
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        alert('Digite um valor v√°lido.');
        return;
      }

      if (!expenses[dateInput]) expenses[dateInput] = [];
      expenses[dateInput].push({ amount, category, note });
      save();
      document.getElementById('amount').value = '';
      document.getElementById('note').value = '';
      updateMetaDisplay();
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    function getTodayTotal() {
      if (!expenses[today]) return 0;
      let total = 0;
      expenses[today].forEach(item => {
        if (item.category === "economia") {
          total -= item.amount;
        } else {
          total += item.amount;
        }
      });
      return total;
    }

    function getWeeklyAverage() {
      const last7 = getDatesLast7Days();
      let total = 0;
      last7.forEach(date => {
        if (expenses[date]) {
          expenses[date].forEach(item => {
            if (item.category === "economia") {
              total -= item.amount;
            } else {
              total += item.amount;
            }
          });
        }
      });
      return total / 7;
    }

    function checkMedal() {
      // Removido ‚Äî foco neutro
    }

    function renderCalendar() {
      const now = new Date(currentYear, currentMonth);
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      let html = '';
      const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
      weekdays.forEach(d => html += `<div class="cal-day">${d}</div>`);

      for (let i = 0; i < startDay; i++) {
        html += '<div class="cal-day"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasData = expenses[dateStr] && expenses[dateStr].length > 0;
        const isToday = dateStr === today;
        let cls = 'cal-day';
        if (hasData) cls += ' has-data';
        if (isToday) cls += ' today';
        html += `<div class="${cls}">${day}</div>`;
      }

      document.getElementById('calendar').innerHTML = html;
    }

    function renderSummaryTable() {
      const tbody = document.getElementById('summaryBody');
      const datesWithExpenses = Object.keys(expenses)
        .filter(date => expenses[date].length > 0)
        .sort((a, b) => new Date(b) - new Date(a));

      if (datesWithExpenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#888;">Nenhum gasto registrado</td></tr>`;
        return;
      }

      let html = '';
      datesWithExpenses.forEach(date => {
        let total = 0;
        expenses[date].forEach(item => {
          if (item.category === "economia") {
            total -= item.amount;
          } else {
            total += item.amount;
          }
        });
        html += `
          <tr>
            <td>${formatBR(date)}</td>
            <td>${formatCurrency(total)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function renderCategoryReport() {
      const report = {};
      for (const date in expenses) {
        expenses[date].forEach(item => {
          if (!report[item.category]) report[item.category] = 0;
          report[item.category] += item.amount;
        });
      }

      const tbody = document.getElementById('categoryReportBody');
      if (Object.keys(report).length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#888;">Nenhum gasto registrado</td></tr>`;
        return;
      }

      const sorted = Object.entries(report).sort((a, b) => b[1] - a[1]);

      let html = '';
      sorted.forEach(([cat, total]) => {
        html += `
          <tr>
            <td>${categoryNames[cat] || cat}</td>
            <td>${formatCurrency(total)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function renderMonthlySummary() {
      const monthDates = getMonthDates(currentYear, currentMonth);
      const daysInMonth = monthDates.length;
      let total = 0;
      let expenseDays = 0;

      monthDates.forEach(date => {
        if (expenses[date] && expenses[date].length > 0) {
          expenseDays++;
          expenses[date].forEach(item => {
            if (item.category === "economia") {
              total -= item.amount;
            } else {
              total += item.amount;
            }
          });
        }
      });

      const avg = daysInMonth > 0 ? total / daysInMonth : 0;

      document.getElementById('currentMonth').textContent = 
        new Date(currentYear, currentMonth, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      document.getElementById('monthlyStats').textContent = 
        `Total: ${formatCurrency(total)} | Dias: ${expenseDays}/${daysInMonth} | M√©dia: ${formatCurrency(avg)}`;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderAll();
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.text("Relat√≥rio de Gastos", 20, 20);

      let y = 35;

      doc.setFontSize(14);
      doc.text("Por Data:", 20, y);
      y += 10;

      const sortedDates = Object.keys(expenses)
        .filter(d => expenses[d].length > 0)
        .sort((a, b) => new Date(a) - new Date(b));

      sortedDates.forEach(date => {
        let total = 0;
        expenses[date].forEach(item => {
          if (item.category === "economia") {
            total -= item.amount;
          } else {
            total += item.amount;
          }
        });
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`${formatBR(date)} ‚Äì Total: ${formatCurrency(total)}`, 20, y);
        y += 8;
        expenses[date].forEach(e => {
          let line = "";
          if (e.category === "economia") {
            line = `‚úÖ ${categoryNames[e.category]}: ${formatCurrency(e.amount)} (prote√ß√£o futura)`;
          } else {
            line = `- ${categoryNames[e.category] || e.category}: ${formatCurrency(e.amount)}`;
          }
          if (e.note) line += ` (${e.note})`;
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text(line, 25, y);
          y += 6;
        });
        y += 6;
      });

      doc.addPage();
      y = 20;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Por Categoria:", 20, y);
      y += 10;

      const report = {};
      for (const date in expenses) {
        expenses[date].forEach(item => {
          if (!report[item.category]) report[item.category] = 0;
          report[item.category] += item.amount;
        });
      }

      const sortedCat = Object.entries(report).sort((a, b) => b[1] - a[1]);
      sortedCat.forEach(([cat, total]) => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`${categoryNames[cat] || cat}: ${formatCurrency(total)}`, 20, y);
        y += 8;
      });

      doc.save('meu-controle-gastos.pdf');
    }

    function renderAll() {
      document.getElementById('balance').textContent = `Balan√ßo de hoje: ${formatCurrency(getTodayTotal())}`;
      document.getElementById('weeklyAverage').textContent = `M√©dia semanal: ${formatCurrency(getWeeklyAverage())}`;
      updateMetaDisplay();
      renderCalendar();
      renderSummaryTable();
      renderCategoryReport();
      renderMonthlySummary();
    }

    function render() {
      renderAll();
    }

    // Inicializa meta
    updateMetaDisplay();
  </script>
</body>
</html>