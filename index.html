<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Controle de Gastos</title>
  
  <!-- Comportamento como app -->
  <meta name="theme-color" content="#4CAF50" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Controle" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Ãcone -->
  <link rel="apple-touch-icon" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%234CAF50'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white'>ğŸ’°</text></svg>">
  <link rel="icon" type="image/png" sizes="192x192" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%234CAF50'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white'>ğŸ’°</text></svg>">

  <style>
    :root {
      --primary: #4CAF50;
      --light: #E8F5E9;
      --dark: #2E7D32;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    body {
      background-color: var(--light);
      color: #333;
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    /* Tela de bloqueio */
    #lockScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    #lockScreen h2 {
      margin-bottom: 20px;
      color: var(--dark);
    }
    #pinInput {
      width: 180px;
      padding: 12px;
      font-size: 1.5rem;
      text-align: center;
      border: 2px solid var(--primary);
      border-radius: 8px;
      margin-bottom: 16px;
    }
    #lockScreen button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    #lockScreen button:hover {
      background: var(--dark);
    }
    #mainApp { display: none; }

    /* Estilos do app */
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 12px 0;
      color: white;
      background: var(--primary);
      border-radius: 12px;
    }
    h1 { font-size: 1.6rem; }
    .balance { 
      background: white; 
      padding: 12px; 
      border-radius: 12px; 
      margin: 16px 0; 
      text-align: center;
      font-weight: bold;
      color: var(--dark);
    }
    .weekly-average {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 12px;
      margin: 12px 0;
      text-align: center;
      color: #1976d2;
      font-weight: bold;
    }
    .form-group { margin: 12px 0; }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    button.app-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 10px;
      cursor: pointer;
    }
    button.app-btn:hover { background: var(--dark); }
    .medal {
      text-align: center;
      font-size: 1.2rem;
      margin: 16px 0;
      color: gold;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin: 16px 0;
    }
    .cal-day {
      text-align: center;
      padding: 6px;
      font-size: 0.9rem;
      background: #e0e0e0;
      border-radius: 4px;
    }
    .cal-day.has-data {
      background: var(--primary);
      color: white;
    }
    .cal-day.today {
      border: 2px solid var(--dark);
    }

    .summary-table, .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .summary-table th,
    .summary-table td,
    .report-table th,
    .report-table td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .summary-table th,
    .report-table th {
      background: var(--primary);
      color: white;
      font-weight: bold;
    }
    .summary-table tr:last-child td,
    .report-table tr:last-child td {
      border-bottom: none;
    }
    .summary-table tr:hover td,
    .report-table tr:hover td {
      background-color: #f9f9f9;
    }

    footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #ccc;
      text-align: center;
      font-size: 0.85rem;
      color: #666;
    }
    footer a {
      color: var(--primary);
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Tela de bloqueio -->
  <div id="lockScreen">
    <h2>ğŸ”’ ProteÃ§Ã£o por PIN</h2>
    <input type="password" id="pinInput" maxlength="4" placeholder="____" autocomplete="off">
    <button onclick="unlockApp()">Acessar</button>
    <button onclick="resetPin()" style="background:#f44336;">Esqueci o PIN</button>
    <p id="pinMessage" style="margin-top:12px;color:#666;"></p>
  </div>

  <!-- App principal -->
  <div id="mainApp">
    <header>
      <h1>ğŸ’° Meu Controle DiÃ¡rio</h1>
    </header>

    <div class="balance" id="balance">BalanÃ§o de hoje: R$ 0,00</div>

    <div class="weekly-average" id="weeklyAverage">MÃ©dia semanal: R$ 0,00</div>

    <div class="form-group">
      <label for="date">Data do gasto</label>
      <input type="date" id="date">
    </div>

    <div class="form-group">
      <label for="category">Categoria</label>
      <select id="category">
        <option value="alimentacao">ğŸ›’ AlimentaÃ§Ã£o</option>
        <option value="feira">ğŸ§º Feira</option>
        <option value="padaria">ğŸ¥ Padaria</option>
        <option value="bares">ğŸ· Bares/Restaurantes</option>
        <option value="farmacia">ğŸ’Š FarmÃ¡cia</option>
        <option value="gasolina">â›½ Gasolina</option>
        <option value="uber">ğŸš• Uber/Transporte</option>
        <option value="agua">ğŸ’§ Ãgua</option>
        <option value="energia">âš¡ Energia</option>
        <option value="telefone">ğŸ“± Telefone/Internet</option>
        <option value="condominio">ğŸ¢ CondomÃ­nio</option>
        <option value="diarista">ğŸ§¹ Diarista</option>
        <option value="impostos">ğŸ›ï¸ Impostos</option>
        <option value="prestacoes">ğŸ  PrestaÃ§Ãµes (casa/carro)</option>
        <option value="manutencao">ğŸ”§ ManutenÃ§Ã£o (casa/carro)</option>
        <option value="lazer">ğŸ­ Lazer</option>
        <option value="contas">ğŸ“„ Contas Fixas</option>
        <option value="aluguel">ğŸ  Aluguel</option>
        <option value="cartao">ğŸ’³ Fatura CartÃ£o</option>
        <option value="dizimo">â¤ï¸ DÃ­zimo/DoaÃ§Ã£o</option>
        <option value="online">ğŸ“¦ Compras Online</option>
        <option value="mensalidade">ğŸ‹ï¸â€â™‚ï¸ Mensalidade (academia/clube)</option>
        <option value="educacao">ğŸ“ EducaÃ§Ã£o</option>
        <option value="ajuda_familia">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ajuda a filhos/netos</option>
        <option value="diversos">âœ¨ Diversos</option>
      </select>
    </div>

    <div class="form-group">
      <label for="amount">Valor (R$)</label>
      <input type="number" id="amount" step="0.01" placeholder="0,00" min="0">
    </div>

    <div class="form-group">
      <label for="note">ObservaÃ§Ã£o (opcional)</label>
      <textarea id="note" placeholder="Ex: Academia Corpo em Forma â€“ saÃºde em primeiro lugar!"></textarea>
    </div>

    <button class="app-btn" onclick="addExpense()">â• Registrar Gasto</button>

    <div class="medal" id="medal"></div>

    <div class="monthly-summary" style="background:white;padding:16px;border-radius:12px;margin:24px 0;text-align:center;">
      <div style="display:flex;justify-content:space-between;max-width:200px;margin:8px auto;">
        <button class="app-btn" style="width:auto;padding:6px 12px;font-size:1rem;" onclick="changeMonth(-1)">â—€</button>
        <span id="currentMonth">Fevereiro 2026</span>
        <button class="app-btn" style="width:auto;padding:6px 12px;font-size:1rem;" onclick="changeMonth(1)">â–¶</button>
      </div>
      <div id="monthlyStats">Total: R$ 0,00 | Dias: 0/29 | MÃ©dia: R$ 0,00</div>
    </div>

    <div class="calendar" id="calendar"></div>

    <h3 style="margin-top: 24px;">ğŸ“… Resumo DiÃ¡rio</h3>
    <table class="summary-table" id="summaryTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="summaryBody">
      </tbody>
    </table>

    <h3>ğŸ“Š Total por Categoria</h3>
    <table class="report-table" id="categoryReport">
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="categoryReportBody">
      </tbody>
    </table>

    <button class="app-btn" style="background:#2196F3;margin-top:20px;" onclick="generatePDF()">ğŸ“„ Gerar RelatÃ³rio PDF</button>

    <button class="app-btn" style="background:#E8F5E9;color:#2E7D32;border:1px solid #4CAF50;margin-top:16px;font-weight:bold;"
            onclick="window.open('https://www.plenalongevidade.com.br', '_blank')">
      ğŸŒ¿ ConheÃ§a a Plena Longevidade
    </button>

    <footer>
      Â© 2026 Ricardo de Faria Barros. Todos os direitos reservados.<br>
      Inspire-se na longelescÃªncia: <a href="https://www.plenalongevidade.com.br" target="_blank">www.plenalongevidade.com.br</a><br>
      <strong>DÃºvidas ou sugestÃµes?</strong> Escreva para: <a href="mailto:ricardo@animodh.com.br">ricardo@animodh.com.br</a>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- FunÃ§Ãµes de seguranÃ§a ---
    function hashPin(pin) {
      let hash = 0;
      for (let i = 0; i < pin.length; i++) {
        const char = pin.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString();
    }

    function setPin(pin) {
      localStorage.setItem('appPinHash', hashPin(pin));
    }

    function verifyPin(pin) {
      const savedHash = localStorage.getItem('appPinHash');
      return savedHash && savedHash === hashPin(pin);
    }

    function hasPin() {
      return localStorage.getItem('appPinHash') !== null;
    }

    function unlockApp() {
      const pin = document.getElementById('pinInput').value;
      const msg = document.getElementById('pinMessage');

      if (pin.length !== 4 || isNaN(pin)) {
        msg.textContent = "O PIN deve ter 4 dÃ­gitos.";
        msg.style.color = "#f44336";
        return;
      }

      if (!hasPin()) {
        setPin(pin);
        msg.textContent = "PIN definido com sucesso!";
        msg.style.color = "#4CAF50";
        setTimeout(() => {
          document.getElementById('lockScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          render();
        }, 1000);
      } else {
        if (verifyPin(pin)) {
          document.getElementById('lockScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          render();
        } else {
          msg.textContent = "PIN incorreto. Tente novamente.";
          msg.style.color = "#f44336";
          document.getElementById('pinInput').value = '';
        }
      }
    }

    function resetPin() {
      if (confirm("Isso apagarÃ¡ todos os seus dados de gastos. Deseja continuar?")) {
        localStorage.removeItem('appPinHash');
        localStorage.removeItem('expenses');
        document.getElementById('pinInput').value = '';
        document.getElementById('pinMessage').textContent = "Dados apagados. Defina um novo PIN.";
        document.getElementById('pinMessage').style.color = "#4CAF50";
      }
    }

    // --- Resto do app ---
    function formatDate(date = new Date()) {
      return date.toISOString().split('T')[0];
    }

    function formatBR(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    function getDatesLast7Days() {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(formatDate(d));
      }
      return dates;
    }

    function getMonthDates(year, month) {
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      const days = [];
      for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
        days.push(formatDate(new Date(d)));
      }
      return days;
    }

    const categoryNames = {
      "alimentacao": "AlimentaÃ§Ã£o",
      "feira": "Feira",
      "padaria": "Padaria",
      "bares": "Bares/Restaurantes",
      "farmacia": "FarmÃ¡cia",
      "gasolina": "Gasolina",
      "uber": "Uber/Transporte",
      "agua": "Ãgua",
      "energia": "Energia",
      "telefone": "Telefone/Internet",
      "condominio": "CondomÃ­nio",
      "diarista": "Diarista",
      "impostos": "Impostos",
      "prestacoes": "PrestaÃ§Ãµes",
      "manutencao": "ManutenÃ§Ã£o",
      "lazer": "Lazer",
      "contas": "Contas Fixas",
      "aluguel": "Aluguel",
      "cartao": "Fatura CartÃ£o",
      "dizimo": "DÃ­zimo/DoaÃ§Ã£o",
      "online": "Compras Online",
      "mensalidade": "Mensalidade (academia/clube)",
      "educacao": "EducaÃ§Ã£o",
      "ajuda_familia": "Ajuda a filhos/netos",
      "diversos": "Diversos"
    };

    let expenses = JSON.parse(localStorage.getItem('expenses')) || {};
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    const today = formatDate();

    document.getElementById('date').value = today;

    function save() {
      localStorage.setItem('expenses', JSON.stringify(expenses));
      render();
    }

    function addExpense() {
      const dateInput = document.getElementById('date').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const note = (document.getElementById('note').value || '').trim();

      if (!dateInput) {
        alert('Selecione uma data.');
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        alert('Digite um valor vÃ¡lido.');
        return;
      }

      if (!expenses[dateInput]) expenses[dateInput] = [];
      expenses[dateInput].push({ amount, category, note });
      save();
      document.getElementById('amount').value = '';
      document.getElementById('note').value = '';
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    function getTodayTotal() {
      if (!expenses[today]) return 0;
      return expenses[today].reduce((sum, e) => sum + e.amount, 0);
    }

    function getWeeklyAverage() {
      const last7 = getDatesLast7Days();
      let total = 0;
      last7.forEach(date => {
        if (expenses[date]) {
          total += expenses[date].reduce((s, e) => s + e.amount, 0);
        }
      });
      return total / 7;
    }

    function checkMedal() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yestStr = formatDate(yesterday);

      const hasToday = !expenses[today] || expenses[today].length === 0;
      const hasYesterday = !expenses[yestStr] || expenses[yestStr].length === 0;

      if (hasToday && hasYesterday) {
        document.getElementById('medal').innerHTML = 'ğŸ† ParabÃ©ns! 2 dias sem gastos!';
      } else {
        document.getElementById('medal').innerHTML = '';
      }
    }

    function renderCalendar() {
      const now = new Date(currentYear, currentMonth);
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      let html = '';
      const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
      weekdays.forEach(d => html += `<div class="cal-day">${d}</div>`);

      for (let i = 0; i < startDay; i++) {
        html += '<div class="cal-day"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasData = expenses[dateStr] && expenses[dateStr].length > 0;
        const isToday = dateStr === today;
        let cls = 'cal-day';
        if (hasData) cls += ' has-data';
        if (isToday) cls += ' today';
        html += `<div class="${cls}">${day}</div>`;
      }

      document.getElementById('calendar').innerHTML = html;
    }

    function renderSummaryTable() {
      const tbody = document.getElementById('summaryBody');
      const datesWithExpenses = Object.keys(expenses)
        .filter(date => expenses[date].length > 0)
        .sort((a, b) => new Date(b) - new Date(a));

      if (datesWithExpenses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#888;">Nenhum gasto registrado</td></tr>`;
        return;
      }

      let html = '';
      datesWithExpenses.forEach(date => {
        const total = expenses[date].reduce((s, e) => s + e.amount, 0);
        html += `
          <tr>
            <td>${formatBR(date)}</td>
            <td>${formatCurrency(total)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function renderCategoryReport() {
      const report = {};
      for (const date in expenses) {
        expenses[date].forEach(item => {
          if (!report[item.category]) report[item.category] = 0;
          report[item.category] += item.amount;
        });
      }

      const tbody = document.getElementById('categoryReportBody');
      if (Object.keys(report).length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#888;">Nenhum gasto registrado</td></tr>`;
        return;
      }

      const sorted = Object.entries(report).sort((a, b) => b[1] - a[1]);

      let html = '';
      sorted.forEach(([cat, total]) => {
        html += `
          <tr>
            <td>${categoryNames[cat] || cat}</td>
            <td>${formatCurrency(total)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function renderMonthlySummary() {
      const monthDates = getMonthDates(currentYear, currentMonth);
      const daysInMonth = monthDates.length;
      const expensesThisMonth = monthDates.filter(d => expenses[d] && expenses[d].length > 0);
      const total = expensesThisMonth.reduce((sum, d) => {
        return sum + expenses[d].reduce((s, e) => s + e.amount, 0);
      }, 0);
      const avg = daysInMonth > 0 ? total / daysInMonth : 0;

      document.getElementById('currentMonth').textContent = 
        new Date(currentYear, currentMonth, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      document.getElementById('monthlyStats').textContent = 
        `Total: ${formatCurrency(total)} | Dias: ${expensesThisMonth.length}/${daysInMonth} | MÃ©dia: ${formatCurrency(avg)}`;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderAll();
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.text("RelatÃ³rio de Gastos", 20, 20);

      let y = 35;

      doc.setFontSize(14);
      doc.text("Por Data:", 20, y);
      y += 10;

      const sortedDates = Object.keys(expenses)
        .filter(d => expenses[d].length > 0)
        .sort((a, b) => new Date(a) - new Date(b));

      sortedDates.forEach(date => {
        const total = expenses[date].reduce((s, e) => s + e.amount, 0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`${formatBR(date)} â€“ Total: ${formatCurrency(total)}`, 20, y);
        y += 8;
        expenses[date].forEach(e => {
          let line = `- ${categoryNames[e.category] || e.category}: ${formatCurrency(e.amount)}`;
          if (e.note) line += ` (${e.note})`;
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text(line, 25, y);
          y += 6;
        });
        y += 6;
      });

      doc.addPage();
      y = 20;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Por Categoria:", 20, y);
      y += 10;

      const report = {};
      for (const date in expenses) {
        expenses[date].forEach(item => {
          if (!report[item.category]) report[item.category] = 0;
          report[item.category] += item.amount;
        });
      }

      const sortedCat = Object.entries(report).sort((a, b) => b[1] - a[1]);
      sortedCat.forEach(([cat, total]) => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`${categoryNames[cat] || cat}: ${formatCurrency(total)}`, 20, y);
        y += 8;
      });

      doc.save('meu-controle-gastos.pdf');
    }

    function renderAll() {
      document.getElementById('balance').textContent = `BalanÃ§o de hoje: ${formatCurrency(getTodayTotal())}`;
      document.getElementById('weeklyAverage').textContent = `MÃ©dia semanal: ${formatCurrency(getWeeklyAverage())}`;
      checkMedal();
      renderCalendar();
      renderSummaryTable();
      renderCategoryReport();
      renderMonthlySummary();
    }

    function render() {
      renderAll();
    }
  </script>
</body>
</html> 